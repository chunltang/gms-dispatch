<!DOCTYPE html>
<html>
  <head>
	<meta charset="utf-8"> 
    <title>车辆实时信息</title>
    <!-- 包含头部信息用于适应不同设备 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 包含 bootstrap 样式表 -->
    <link rel="stylesheet" href="https://apps.bdimg.com/libs/bootstrap/3.2.0/css/bootstrap.min.css">
  </head>

  <body>
    <div class="container" style="width: 90%; height: auto;">
      <h2>车辆实时信息</h2>
      <div class="table-responsive" >          
       <table   class="table table-striped table-bordered">
         <thead>
           <tr id='first-tr'>
             <th>车编号</th>
             <th>调度状态</th>
             <th>任务状态</th>
             <th>vak指令</th>
             <th>控制模式</th>
             <th>是否允许运行</th>
             <th>是否下发轨迹</th>
             <th>车辆位置</th>
             <th>车辆速度m/s</th>
             <th>车辆区域位置</th>
             <th>路径状态</th>
             <th>全局路径总点数</th>
             <th>最近点id</th>
             <th>车辆终点位置</th>
             <th>车辆终点区域</th>
             <th>路径偏差m</th>
           </tr>
         </thead>
         <tbody>
         
         </tbody>
       </table>
      </div>
    </div>

    <!-- JavaScript 放置在文档最后面可以使页面加载速度更快 -->
    <!-- 可选: 包含 jQuery 库 -->
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <!-- 可选: 合并了 Bootstrap JavaScript 插件 -->
    <script src="https://apps.bdimg.com/libs/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>

</html>

<script type="text/javascript">
    var websocket = null;

    //判断当前浏览器是否支持WebSocket
    if('WebSocket' in window){
        websocket = new WebSocket("ws://192.168.2.100:8081/webSocket?authorization=451338e2-fcdb-46e5-94fb-c73812a9477c");
    }
    else{
        alert('Not support websocket')
    }


    //连接发生错误的回调方法
    websocket.onerror = function(){
        console.log('error');
    };

    //连接成功建立的回调方法
    websocket.onopen = function(event){
        send();
    }

    //接收到消息的回调方法
    websocket.onmessage = function(event){
        setMessageInnerHTML(event.data);
    }

    //连接关闭的回调方法
    websocket.onclose = function(){
        console.log('close');
    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function(){
        websocket.close();
    }

    //将消息显示在网页上
    function setMessageInnerHTML(data){
        var json=JSON.parse(data);
        var obj=JSON.parse(json.data);
        var vehicleId=obj.vehicleId;
        if(undefined==vehicleId){
          return;
        }
        var $tr=$("tbody tr").has(":contains("+vehicleId+")");
      
        var html="<tr>";
        html+="<td>"+handleAttr(obj.vehicleId)+"</td>";
        html+="<td>"+handleAttr(obj.dispatchState)+"</td>";
        html+="<td>"+handleAttr(obj.taskState)+"</td>";
        html+="<td>"+handleAttr(obj.taskCode)+"</td>";
        html+="<td>"+handleAttr(obj.vakMode)+"</td>";
        html+="<td>"+handleAttr(obj.isStart)+"</td>";
        html+="<td>"+handleAttr(obj.isRunning)+"</td>";
        html+="<td>"+handleAttr(obj.curPoint).replace(/\,/g,'\n')+"</td>";
        html+="<td>"+handleAttr(obj.curSpeed)+"</td>";
        html+="<td>"+handleAttr(obj.curArea)+"</td>";
        html+="<td>"+handleAttr(obj.pathState)+"</td>";
        html+="<td>"+handleAttr(obj.pathCount)+"</td>";
        html+="<td>"+handleAttr(obj.pathNearestId)+"</td>";
        html+="<td>"+handleAttr(obj.endPoint).replace(/\,/g,'\n')+"</td>";
        html+="<td>"+handleAttr(obj.endArea)+"</td>";
        html+="<td>"+handleAttr(obj.deviation)+"</td>";
        html+="</tr>";
        if($tr.length>0){
           $tr.html('');
        }

       $("tbody").append(html);
       sort();
    }

    //处理空数据
    function handleAttr(attr){
        return undefined==attr?'':attr;
    }

    //表行排序 https://www.cnblogs.com/CreateMyself/p/5516858.html
    function sort(){
         var $trs=$("tr:not('.first-tr')");
         $trs.sort(function(obj1,obj2){
             var $td1=$(obj1).children("td:first");
             var $td2=$(obj2).children("td:first");
             if(parseInt($td1.text())>parseInt($td2.text())){
                 return 1;
             }else if(parseInt($td1.text())<parseInt($td2.text())){
                 return -1;
             }
             return 0;
         });
         $trs.detach().appendTo("tbody");
    }
    //关闭连接
    function closeWebSocket(){
        websocket.close();
    }

    //发送消息
    function send(){
        var message = {"funcName":"test","type":"add","vehicleId":"10001"};
        websocket.send(JSON.stringify(message));
    }
</script>